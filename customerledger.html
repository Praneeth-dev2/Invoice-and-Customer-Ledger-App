<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Customer Ledger</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="styles.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  </head>
  <body>
    <div class="container">
      <!-- Tab Navigation -->
      <div class="tab-navigation">
        <button class="tab-btn" onclick="window.location.href = 'index.html'">
          üìÑ Invoice
        </button>
        <button
          class="tab-btn active"
          onclick="window.location.href = 'customerledger.html'"
        >
          üìí Customer Ledger
        </button>
      </div>

      <div class="header">
        <h1>üìí Customer Ledger</h1>
        <p class="text-muted mb-0">Manage customer credit/debit ledger</p>
      </div>

      <!-- Main View: Customer List -->
      <div id="customerListView">
        <!-- Reports Section -->
        <div class="reports-section">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0">üìä Summary Reports</h4>
            <button
              class="btn btn-sm"
              id="resetReportsBtn"
              onclick="resetReports()"
              disabled
              style="
                background-color: #dc3545;
                border-color: #dc3545;
                color: white;
              "
              title="Reset reports (only available when balance is 0)"
            >
              üîÑ Reset
            </button>
          </div>
          <div class="row">
            <div class="col-md-4 mb-3">
              <div class="report-card" style="border-left: 4px solid #dc3545">
                <div class="report-label">To Be Collected</div>
                <div class="report-value text-danger" id="totalCredit">
                  ‚Çπ0.00
                </div>
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="report-card" style="border-left: 4px solid #28a745">
                <div class="report-label">Total Amount Received</div>
                <div class="report-value text-success" id="totalDebit">
                  ‚Çπ0.00
                </div>
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="report-card" style="border-left: 4px solid #ffc107">
                <div class="report-label">Total Pending Balance</div>
                <div class="report-value text-warning" id="totalPending">
                  ‚Çπ0.00
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Customer Management -->
        <div class="item-form">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0">Customer List</h4>
            <button
              class="btn btn-action"
              onclick="showAddCustomerModal()"
              style="
                background-color: #bc6c25;
                border-color: #bc6c25;
                color: white;
              "
            >
              <ion-icon name="person-add-outline"></ion-icon>
              <span>Add Customer</span>
            </button>
          </div>

          <!-- Search Box -->
          <div class="search-box mb-3">
            <input
              type="text"
              class="form-control"
              id="customerSearch"
              placeholder="Search by customer name or phone..."
              onkeyup="searchCustomers()"
            />
          </div>

          <!-- Customer Table -->
          <div class="table-responsive">
            <table class="table table-bordered table-hover">
              <thead style="background-color: #bc6c25; color: white">
                <tr>
                  <th>S.No</th>
                  <th>Customer Name</th>
                  <th>Phone</th>
                  <th>Balance</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="customerTableBody">
                <tr>
                  <td colspan="5" class="text-center text-muted">
                    No customers added yet
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Export Options -->
        <div class="action-buttons mt-4">
          <button
            class="btn btn-action"
            onclick="exportAllCustomersCSV()"
            style="
              background-color: #606c38;
              border-color: #606c38;
              color: white;
            "
          >
            üì• Export All to Excel
          </button>
          <button
            class="btn btn-action"
            onclick="clearAllKhatabookData()"
            style="
              background-color: #dc3545;
              border-color: #dc3545;
              color: white;
            "
          >
            üóëÔ∏è Clear All Data
          </button>
        </div>
      </div>

      <!-- Customer Detail View (Hidden by default) -->
      <div id="customerDetailView" style="display: none">
        <button
          class="btn btn-action mb-3"
          onclick="backToCustomerList()"
          style="background-color: #283618; border-color: #283618; color: white"
        >
          <ion-icon name="arrow-back-outline"></ion-icon>
          <span>Back to Customer List</span>
        </button>

        <!-- Customer Info Card -->
        <div class="item-form">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
              <h4 class="mb-1" id="detailCustomerName">Customer Name</h4>
              <p class="text-muted mb-0" id="detailCustomerPhone">Phone: -</p>
              <p class="text-muted mb-0" id="detailCustomerNotes">Notes: -</p>
            </div>
            <div>
              <h5 class="mb-0">Current Balance</h5>
              <h3
                class="mb-0"
                id="detailCustomerBalance"
                style="color: #bc6c25"
              >
                ‚Çπ0.00
              </h3>
            </div>
          </div>
        </div>

        <!-- Add Transaction Form -->
        <div class="item-form">
          <h4 class="mb-3">Add Transaction</h4>
          <form id="transactionForm">
            <div class="row">
              <div class="col-md-3 mb-3">
                <label for="transactionType" class="form-label">Type</label>
                <select class="form-control" id="transactionType" required>
                  <option value="credit">Debit (Customer Owes)</option>
                  <option value="debit">Credit (Customer Paid)</option>
                </select>
              </div>
              <div class="col-md-3 mb-3">
                <label for="transactionAmount" class="form-label"
                  >Amount (‚Çπ)</label
                >
                <input
                  type="number"
                  class="form-control"
                  id="transactionAmount"
                  min="0"
                  step="0.01"
                  required
                />
              </div>
              <div class="col-md-3 mb-3">
                <label for="transactionDate" class="form-label">Date</label>
                <input
                  type="date"
                  class="form-control"
                  id="transactionDate"
                  required
                />
              </div>
              <div class="col-md-3 mb-3">
                <label for="transactionDescription" class="form-label"
                  >Description</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="transactionDescription"
                  placeholder="Optional"
                />
              </div>
            </div>
            <button
              type="submit"
              class="btn btn-action"
              style="
                background-color: #bc6c25;
                border-color: #bc6c25;
                color: white;
              "
            >
              <ion-icon name="add-circle-outline"></ion-icon>
              <span>Add Transaction</span>
            </button>
          </form>
        </div>

        <!-- Transaction History / Ledger Table -->
        <div class="items-table">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0">Transaction History</h4>
            <button
              class="btn btn-sm"
              onclick="toggleTransactionOrder()"
              id="transactionSortBtn"
              style="
                background-color: #bc6c25;
                border-color: #bc6c25;
                color: white;
              "
            >
              <ion-icon name="swap-vertical-outline"></ion-icon>
              <span id="transactionSortText">Oldest First</span>
            </button>
          </div>
          <div class="table-responsive">
            <table class="table table-bordered table-hover">
              <thead style="background-color: #bc6c25; color: white">
                <tr>
                  <th>Date</th>
                  <th>Description</th>
                  <th>Debit (Owes)</th>
                  <th>Credit (Paid)</th>
                  <th>Balance (‚Çπ)</th>
                </tr>
              </thead>
              <tbody id="transactionTableBody">
                <tr>
                  <td colspan="5" class="text-center text-muted">
                    No transactions yet
                  </td>
                </tr>
              </tbody>
              <tfoot
                id="transactionTableFooter"
                style="
                  display: none;
                  background-color: #fefae0;
                  font-weight: bold;
                "
              >
                <tr>
                  <td colspan="2" class="text-end">Total:</td>
                  <td id="footerTotalCredit">‚Çπ0.00</td>
                  <td id="footerTotalDebit">‚Çπ0.00</td>
                  <td id="footerTotalBalance">‚Çπ0.00</td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>

        <!-- Export Options for Customer -->
        <div class="action-buttons mt-4">
          <button
            class="btn btn-action"
            onclick="viewStatement()"
            style="
              background-color: #606c38;
              border-color: #606c38;
              color: white;
            "
          >
            üëÅÔ∏è View Statement
          </button>
          <button
            class="btn btn-action"
            onclick="toggleDateRangeStatement()"
            style="
              background-color: #bc6c25;
              border-color: #bc6c25;
              color: white;
            "
          >
            üìÖ View by Date Range
          </button>
          <button
            class="btn btn-action"
            onclick="exportCustomerPDF()"
            style="
              background-color: #dda15e;
              border-color: #dda15e;
              color: white;
            "
          >
            üìÑ Export to PDF
          </button>
          <button
            class="btn btn-action"
            onclick="deleteCurrentCustomer()"
            style="
              background-color: #dc3545;
              border-color: #dc3545;
              color: white;
            "
          >
            üóëÔ∏è Delete Customer
          </button>
        </div>

        <!-- Date Range Picker for Statement (hidden by default) -->
        <div
          class="date-range-picker mt-3"
          id="dateRangeStatement"
          style="display: none"
        >
          <div class="row g-2 align-items-end">
            <div class="col-md-4">
              <label for="statementStartDate" class="form-label"
                >Start Date</label
              >
              <input type="date" class="form-control" id="statementStartDate" />
            </div>
            <div class="col-md-4">
              <label for="statementEndDate" class="form-label">End Date</label>
              <input type="date" class="form-control" id="statementEndDate" />
            </div>
            <div class="col-md-4">
              <button
                class="btn btn-primary w-100"
                onclick="viewStatementByDateRange()"
              >
                üëÅÔ∏è View Statement
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Customer Modal -->
    <div class="modal fade" id="addCustomerModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div
            class="modal-header"
            style="background-color: #bc6c25; color: white"
          >
            <h5 class="modal-title">
              <ion-icon name="person-add-outline"></ion-icon>
              Add New Customer
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="addCustomerForm">
              <div class="mb-3">
                <label for="customerName" class="form-label"
                  >Customer Name *</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="customerName"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="customerPhone" class="form-label"
                  >Phone Number</label
                >
                <input
                  type="tel"
                  class="form-control"
                  id="customerPhone"
                  placeholder="Optional"
                />
              </div>
              <div class="mb-3">
                <label for="customerNotes" class="form-label">Notes</label>
                <textarea
                  class="form-control"
                  id="customerNotes"
                  rows="3"
                  placeholder="Optional"
                ></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn"
              onclick="addCustomer()"
              style="
                background-color: #bc6c25;
                border-color: #bc6c25;
                color: white;
              "
            >
              Add Customer
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="customerledger.js"></script>
    <script
      type="module"
      src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"
    ></script>
    <script
      nomodule
      src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"
    ></script>
  </body>
</html>
